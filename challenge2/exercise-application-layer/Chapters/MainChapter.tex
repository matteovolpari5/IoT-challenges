\section{Data}

The data of the exercise is reported here.
\begin{itemize}
	\item $T_{sensor\_reading} = 5 \text{ minutes}$
	\item $T_{average\_computation} = 30 \text{ minutes}$
	\item $L_{resource} = L_{topic} = 10  \text{ Bytes}$
	\item $L_{payload} = 8  \text{ Bytes}$
	\item $E_{TX} = 50 \text{ nJ/bit}$
	\item $E_{RX} = 58 \text{ nJ/bit}$
	\item Ideal Wi-Fi network 
	\item $E_{C} = 2.4 \text{ mJ}$
\end{itemize}

The message sizes of the two protocols are reported in the following tables.

\begin{table}[H]
\centering 
\begin{tabular}{| c | c |}
	\hline 
	\rowcolor{bluepoli!40}
	\textbf{Message} & \textbf{Size [Byte]}\T\B \\
	\hline 
	GET Request & 60 \T\B\\
	GET Response  & 55 \T\B\\
	PUT Request & 77 \T\B\\
	PUT Response & 58 \T\B\\
	Empty ACK & 14 \T\B\\
	\hline
\end{tabular}
\\[10pt]
\caption{Message sizes CoAP}
\end{table}

\begin{table}[H]
\centering 
\begin{tabular}{| c | c |}
	\hline 
	\rowcolor{bluepoli!40}
	\textbf{Message} & \textbf{Size [Byte]}\T\B \\
	\hline 
	Subscribe & 58 \T\B\\
	Sub ACK & 52 \T\B\\
	Publish & 68 \T\B\\
	Pub Ack & 51 \T\B\\
	Connect & 54\T\B\\
	Connect Ack & 47 \T\B\\
	Ping Req & 52 \T\B\\
	Ping Resp & 48 \T\B\\
	\hline
\end{tabular}
\\[10pt]
\caption{Message sizes MQTT}
\end{table}

\section{EQ1.a Energy consumed using CoAP}
We start by computing the energy consumed by the two devices when they communicate using CoAP in the most efficient configuration energy-wise. The temperature sensor acts as a CoAP Server, while the valve as a CoAP Client.\\
In order to save energy, we use CoAP Observation and Non-confirmable requests. The valve (Client) sends a GET Request with Observe to the temperature sensor (Server). The sensor sends the requested value to the Client every 5 minutes, with a GET Response. Moreover, the valve computes the average every 30 minutes.\\
We start by computing the number of sensor readings, $N_{sensor\_read}$, and the number of computations of the average, $N_{avg}$.
\[N_{sensor\_read} = (24\text{ h}  \cdot 60 \text{ min/h}) / 5 \text{ min} = 288\]
\[N_{avg} = (24\text{ h}  \cdot 60 \text{ min/h}) / 30 \text{ min} = 48\]

We can compute the energy consumed by the two devices as:
\[E_{CoAP\_valve} = E_{TX} \cdot L_{GET\_Req} + N_{sensor\_read} \cdot E_{RX} \cdot L_{GET\_Resp} + N_{avg} \cdot E_{C} = 122.574 \text{ mJ}\]
\[E_{CoAP\_sensor} = E_{RX} \cdot L_{GET\_Req} + N_{sensor\_read} \cdot E_{TX} \cdot L_{GET\_Resp} = 6.364 \text{ mJ}\]
\[E_{CoAP\_total} = E_{CoAP\_valve} + E_{CoAP\_sensor} = 128.938 \text{ mJ}\]

\section{EQ1.b Energy consumed using MQTT}
In this section, we compute the energy consumption if the devices communicate through MQTT. In this scenario, the Raspberry PI acts as MQTT Broker, the sensor is a Publisher and the valve is a Subscriber. In order to minimize energy consumption, messages are exchanged with QoS 0 and without the Keep Alive mechanism, i.e. with Keep Alive 0. The sensor (Publisher) connects to the Broker and starts publishing temperature values every 5 minutes. The valve (Subscriber) connects to the Broker, subscribes to the topic and starts receiving temperature values.

We can compute the energy consumed by the two devices as:
\[E_{MQTT\_valve} = E_{TX} \cdot L_{CONNECT} + E_{RX} \cdot L_{CONNACK} + E_{TX} \cdot L_{SUBSCRIBE} +\]
\[+ E_{RX} \cdot L_{SUBACK} + N_{sensor\_read} \cdot E_{RX} \cdot L_{PUBLISH} + N_{avg} \cdot E_{C} = 124.378 \text{ mJ}\]
\[E_{MQTT\_sensor} = E_{TX} \cdot L_{CONNECT} + E_{RX} \cdot L_{CONNACK} + N_{sensor\_read} \cdot E_{TX} \cdot L_{PUBLISH} =\]
\[= 7.877 \text{ mJ}\]
\[E_{MQTT\_total} = E_{MQTT\_valve} + E_{MQTT\_sensor} = 132.255 \text{ mJ}\]

\section{EQ2 Improvements}
In this section, we propose two ways to decrease the energy consumed by the two device while using the Raspberry PI as a broker. 
\subsection{Using MQTT-SN}
The first improvement consists in using MQTT-SN instead of MQTT. Using MQTT-SN introduces a trade-off: 
\begin{itemize}
	\item Disadvantage: the Publisher needs to send a REGISTER message to the broker, represented by the Raspberry PI, before being able to send PUBLISH messages.
	\item Advantage: PUBLISH messages have a reduced size, since they have a 2 Bytes long topic, instead of the 10 Bytes long one of MQTT messages.
\end{itemize}
On the long run, using MQTT-SN is beneficial, since we send more messages and compensate the initial cost of the REGISTER message with the lowered cost of PUBLISH messages. We need to compute the energy consumption in our time horizon of 24 hours and see if it is long enough to consume less energy.

// TODO calcoli

We can see that the new energy consumption is smaller than the one computed using MQTT.

// TODO potrebbe essere che inviando ogni 10 minuti, non conviene pi√π MQTT-SN rispetto a MQTT.












